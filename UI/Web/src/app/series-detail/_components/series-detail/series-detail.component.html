<ng-container *transloco="let t; read: 'series-detail'">
  <div #companionBar>
    @if (series) {
      <app-side-nav-companion-bar [hasExtras]="false">
        <ng-container title>
          <h4 class="title text-break">
            <app-card-actionables (actionHandler)="performAction($event)" [actions]="seriesActions" [labelBy]="series.name" iconClass="fa-ellipsis-v"></app-card-actionables>
            <span>{{series.name}}
              @if(isLoadingExtra || isLoading) {
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">loading...</span>
                </div>
              }
            </span>
          </h4>
        </ng-container>
        @if (series.localizedName !== series.name) {
          <ng-container subtitle>
            <h5 class="subtitle-with-actionables text-break" title="Localized Name">{{series.localizedName}}</h5>
          </ng-container>
        }


<!--        <ng-template #extrasDrawer let-offcanvas>-->
<!--          <div>-->
<!--            <div class="offcanvas-header">-->
<!--              <h4 class="offcanvas-title" id="offcanvas-basic-title">{{t('page-settings-title')}}</h4>-->
<!--              <button type="button" class="btn-close" [attr.aria-label]="t('close')" (click)="offcanvas.dismiss()"></button>-->
<!--            </div>-->
<!--            <div class="offcanvas-body">-->
<!--              <form [formGroup]="pageExtrasGroup">-->
<!--                <div class="row g-0">-->
<!--                  <div class="col-md-12 col-sm-12 pe-2 mb-3">-->
<!--                    <label id="list-layout-mode-label" class="form-label">{{t('layout-mode-label')}}</label>-->
<!--                    <br/>-->
<!--                    <div class="btn-group d-flex justify-content-center" role="group" [attr.aria-label]="t('page-settings-title')">-->
<!--                      <input type="radio" formControlName="renderMode" [value]="PageLayoutMode.Cards" class="btn-check" id="layout-mode-default" autocomplete="off">-->
<!--                      <label class="btn btn-outline-primary" for="layout-mode-default">{{t('layout-mode-option-card')}}</label>-->

<!--                      <input type="radio" formControlName="renderMode" [value]="PageLayoutMode.List" class="btn-check" id="layout-mode-col1" autocomplete="off">-->
<!--                      <label class="btn btn-outline-primary" for="layout-mode-col1">{{t('layout-mode-option-list')}}</label>-->
<!--                    </div>-->
<!--                  </div>-->
<!--                </div>-->
<!--              </form>-->
<!--            </div>-->
<!--          </div>-->
<!--        </ng-template>-->


      </app-side-nav-companion-bar>
    }

  </div>

  <app-bulk-operations [actionCallback]="bulkActionCallback" [topOffset]="56"></app-bulk-operations>

  @if (series) {
    <div [ngStyle]="{'height': ScrollingBlockHeight}" class="main-container container-fluid pt-2" #scrollingBlock>
      <div class="row mb-0 mb-xl-3 info-container">
        <div class="image-container col-4 col-sm-6 col-md-4 col-lg-4 col-xl-2 col-xxl-2 d-none d-sm-block mt-2">
          @if (unreadCount > 0 && unreadCount !== totalCount) {
            <div class="to-read-counter">
              <app-tag-badge [selectionMode]="TagBadgeCursor.NotAllowed" fillStyle="filled">{{unreadCount}}</app-tag-badge>
            </div>
          }

          <app-image [styles]="{'object-fit': 'contain', 'background': 'none', 'max-height': '400px', 'height': '100%'}" height="400px"  [imageUrl]="seriesImage"></app-image>
          @if (series.pagesRead < series.pages && hasReadingProgress && currentlyReadingChapter && !currentlyReadingChapter.isSpecial) {
            <div class="progress-banner" ngbTooltip="{{(series.pagesRead / series.pages) * 100 | number:'1.0-1'}}% Read">
              <ngb-progressbar type="primary" [value]="series.pagesRead" [max]="series.pages" [showValue]="true"></ngb-progressbar>
            </div>
            <div class="under-image">
              {{t('continue-from', {title: ContinuePointTitle})}}
            </div>
          }
        </div>
        <div class="col-xlg-10 col-lg-8 col-md-8 col-xs-8 col-sm-6 mt-2">
          <div class="row g-0">
            <div class="col-auto">
              <div class="btn-group">
                <button type="button" class="btn btn-primary-outline" (click)="read()">
              <span>
                <i class="fa {{showBook ? 'fa-book-open' : 'fa-book'}}" aria-hidden="true"></i>
                <span class="read-btn--text">&nbsp;{{(hasReadingProgress) ? t('continue') : t('read')}}</span>
              </span>
                </button>
                <div class="btn-group" ngbDropdown role="group" display="dynamic" [attr.aria-label]="t('read-options-alt')">
                  <button type="button" class="btn btn-primary-outline dropdown-toggle-split" ngbDropdownToggle></button>
                  <div class="dropdown-menu" ngbDropdownMenu>
                    <button ngbDropdownItem (click)="read(true)">
                  <span>
                    <i class="fa fa-glasses" aria-hidden="true"></i>
                    <span class="read-btn--text">&nbsp;{{(hasReadingProgress) ? t('continue-incognito') : t('read-incognito')}}</span>
                  </span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-auto ms-2">
              <button class="btn btn-secondary-outline" (click)="toggleWantToRead()" title="{{isWantToRead ? t('remove-from-want-to-read') : t('add-to-want-to-read')}}">
                <span>
                    <i class="{{isWantToRead ? 'fa-solid' : 'fa-regular'}} fa-star" aria-hidden="true"></i>
                </span>
              </button>
            </div>

            @if (isAdmin) {
              <div class="col-auto ms-2">
                <button class="btn btn-secondary-outline" id="edit-btn--komf" (click)="openEditSeriesModal()" [title]="t('edit-series-alt')">
                  <span><i class="fa fa-pen" aria-hidden="true"></i></span>
                </button>
              </div>
            }

            <div class="col-auto ms-2 d-none d-md-block">
              <div class="card-actions">
                <app-card-actionables (actionHandler)="performAction($event)" [actions]="seriesActions" [labelBy]="series.name" iconClass="fa-ellipsis-h" btnClass="btn-secondary-outline"></app-card-actionables>
              </div>
            </div>

            @if (isAdmin || hasDownloadingRole) {
              <div class="col-auto ms-2 d-none d-md-block">
                @if (download$ | async; as download) {
                  <button class="btn btn-secondary-outline" (click)="downloadSeries()" [title]="t('download-tooltip')" [disabled]="download !== null">
                    @if (download !== null) {
                      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                      <span class="visually-hidden">{{t('downloading-status')}}</span>
                    } @else {
                      <i class="fa fa-arrow-alt-circle-down" aria-hidden="true"></i>
                    }
                  </button>
                } @else {
                  <button class="btn btn-secondary-outline" (click)="downloadSeries()" [title]="t('download-tooltip')">
                    <i class="fa fa-arrow-alt-circle-down" aria-hidden="true"></i>
                  </button>
                }
              </div>
            }

          </div>

          @if (seriesMetadata) {
            <div class="mt-2">
              <app-series-metadata-detail [seriesMetadata]="seriesMetadata" [readingLists]="readingLists" [series]="series"
                                          [libraryType]="libraryType" [ratings]="ratings"
                                          [hasReadingProgress]="hasReadingProgress"></app-series-metadata-detail>
            </div>
          }

        </div>
      </div>

      @if (series) {
        <ul ngbNav #nav="ngbNav" [(activeId)]="activeTabId" class="nav nav-tabs mb-2" [destroyOnHide]="false" (navChange)="onNavChange($event)">

          @if (showStorylineTab) {
            <li [ngbNavItem]="TabID.Storyline">
              <a ngbNavLink>{{t('storyline-tab')}}</a>
              <ng-template ngbNavContent>
                @defer (when activeTabId === TabID.Storyline; prefetch on idle) {
                  <virtual-scroller #scroll [items]="storylineItems" [bufferAmount]="1" [parentScroll]="scrollingBlock" [childHeight]="1">

                    <div class="card-container row g-0" #container>
                      @for(item of scroll.viewPortItems; let idx = $index; track item.id + '_' + item.pagesRead) {
                        @if (item.isChapter) {
                          <ng-container [ngTemplateOutlet]="nonSpecialChapterCard" [ngTemplateOutletContext]="{$implicit: item.chapter, scroll: scroll, idx: idx, chaptersLength: storyChapters.length}"></ng-container>
                        } @else {
                          <ng-container [ngTemplateOutlet]="nonChapterVolumeCard" [ngTemplateOutletContext]="{$implicit: item.volume, scroll: scroll, idx: idx, volumesLength: volumes.length}"></ng-container>
                        }
                      }

                      <ng-container [ngTemplateOutlet]="estimatedNextCard" [ngTemplateOutletContext]="{tabId: TabID.Storyline}"></ng-container>
                    </div>
                  </virtual-scroller>
                }
              </ng-template>
            </li>
          }


          @if (showVolumeTab) {
            <li [ngbNavItem]="TabID.Volumes">
              <a ngbNavLink>
                {{UseBookLogic ? t('books-tab') : t('volumes-tab')}}
                <span class="badge rounded-pill text-bg-secondary">{{volumes.length}}</span>
              </a>
              <ng-template ngbNavContent>
                @defer (when activeTabId === TabID.Volumes; prefetch on idle) {
                  <virtual-scroller #scroll [items]="volumes" [parentScroll]="scrollingBlock" [childHeight]="1">
                    <div class="card-container row g-0" #container>
                      @for (item of scroll.viewPortItems; let idx = $index; track item.id + '_' + item.pagesRead) {
                        <ng-container [ngTemplateOutlet]="nonChapterVolumeCard" [ngTemplateOutletContext]="{$implicit: item, scroll: scroll, idx: idx, totalLength: volumes.length}"></ng-container>
                      }
                      <ng-container [ngTemplateOutlet]="estimatedNextCard" [ngTemplateOutletContext]="{tabId: TabID.Volumes}"></ng-container>
                    </div>
                  </virtual-scroller>
                }
              </ng-template>
            </li>
          }

          @if (showChapterTab) {
            <li [ngbNavItem]="TabID.Chapters">
              <a ngbNavLink>
                {{utilityService.formatChapterName(libraryType)}}
                <span class="badge rounded-pill text-bg-secondary">{{chapters.length}}</span>
              </a>
              <ng-template ngbNavContent>
                @defer (when activeTabId === TabID.Chapters; prefetch on idle) {
                  <virtual-scroller #scroll [items]="chapters" [parentScroll]="scrollingBlock" [childHeight]="1">
                    <div class="card-container row g-0" #container>
                      @for (item of scroll.viewPortItems; let idx = $index; track item.id + '_' + item.pagesRead) {
                        <ng-container [ngTemplateOutlet]="nonSpecialChapterCard" [ngTemplateOutletContext]="{$implicit: item, scroll: scroll, idx: idx, totalLength: chapters.length}"></ng-container>
                      }
                      <ng-container [ngTemplateOutlet]="estimatedNextCard" [ngTemplateOutletContext]="{tabId: TabID.Chapters}"></ng-container>
                    </div>
                  </virtual-scroller>
                }
              </ng-template>
            </li>
          }

          @if (hasSpecials) {
            <li [ngbNavItem]="TabID.Specials">
              <a ngbNavLink>
                {{t('specials-tab')}}
                <span class="badge rounded-pill text-bg-secondary">{{specials.length}}</span>
              </a>
              <ng-template ngbNavContent>
                @defer (when activeTabId === TabID.Specials; prefetch on idle) {
                  <virtual-scroller #scroll [items]="specials"  [parentScroll]="scrollingBlock" [childHeight]="1">
                    <div class="card-container row g-0" #container>
                      @for(item of scroll.viewPortItems; let idx = $index; track item.id + '_' + item.pagesRead) {
                        <ng-container [ngTemplateOutlet]="specialChapterCard" [ngTemplateOutletContext]="{$implicit: item, scroll: scroll, idx: idx, chaptersLength: chapters.length}"></ng-container>
                      }
                    </div>
                  </virtual-scroller>
                }
              </ng-template>
            </li>
          }

          @if (hasRelations && relationShips) {
            <li [ngbNavItem]="TabID.Related">
              <a ngbNavLink>
                {{t('related-tab')}}
                <span class="badge rounded-pill text-bg-secondary">{{relations.length}}</span>
              </a>
              <ng-template ngbNavContent>
                @defer (when activeTabId === TabID.Related; prefetch on idle) {
                  <virtual-scroller #scroll [items]="relations" [parentScroll]="scrollingBlock" [childHeight]="1">
                    <div class="card-container row g-0" #container>
                      @for(item of scroll.viewPortItems; let idx = $index; track item.id) {
                        <app-series-card class="col-auto mt-2 mb-2" [series]="item.series" [libraryId]="item.series.libraryId" [relation]="item.relation"></app-series-card>
                      }
                    </div>
                  </virtual-scroller>
                }

<!--                @if (relationShips.prequels.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.prequels" title="Prequels">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Prequel"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.sequels.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.sequels" title="Sequels">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Sequel"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.parent.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.parent" title="Parent">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Parent"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.contains.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.contains" title="Contains">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Contains"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.adaptations.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.adaptations" title="Contains">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Adaptation"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.annuals.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.annuals" title="Annuals">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Annual"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->


<!--                @if (relationShips.characters.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.characters" title="Characters">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Character"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.alternativeSettings.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.alternativeSettings" title="Alternative Settings">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.AlternativeSetting"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.doujinshis.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.doujinshis" title="Doujinshis">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Doujinshi"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.alternativeVersions.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.alternativeVersions" title="Alternative Versions">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.AlternativeVersion"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.editions.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.editions" title="Editions">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Edition"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.others.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.others" title="Other">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.Other"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->

<!--                @if (relationShips.sideStories.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.sideStories" title="Side Stories">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.SideStory"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->


<!--                @if (relationShips.spinOffs.length > 0) {-->
<!--                  <app-carousel-reel [items]="relationShips.spinOffs" title="Spin Offs">-->
<!--                    <ng-template #carouselItem let-item>-->
<!--                      <app-series-card class="col-auto mt-2 mb-2" [series]="item" [libraryId]="item.libraryId" [relation]="RelationKind.SpinOff"></app-series-card>-->
<!--                    </ng-template>-->
<!--                  </app-carousel-reel>-->
<!--                }-->


              </ng-template>
            </li>
          }

          @if (hasRecommendations) {
            <li [ngbNavItem]="TabID.Recommendations">
              <a ngbNavLink>{{t('recommendations-tab')}}</a>
              <ng-template ngbNavContent>
                @defer (when activeTabId === TabID.Recommendations; prefetch on idle) {
                  <virtual-scroller #scroll [items]="combinedRecs" [parentScroll]="scrollingBlock" [childHeight]="1">
                    <div class="card-container row g-0" #container>
                      @for(item of scroll.viewPortItems; let idx = $index; track idx) {
                        @if (!item.hasOwnProperty('coverUrl')) {
                          <app-series-card class="col-auto mt-2 mb-2" [series]="item" [previewOnClick]="true" [libraryId]="item.libraryId"></app-series-card>
                        } @else {
                          <app-external-series-card class="col-auto mt-2 mb-2" [previewOnClick]="true" [data]="item"></app-external-series-card>
                        }
                      }
                    </div>
                  </virtual-scroller>
                }
              </ng-template>
            </li>
          }

          <li [ngbNavItem]="TabID.Reviews">
            <a ngbNavLink>{{t('reviews-tab')}}</a>
            <ng-template ngbNavContent>
              @defer (when activeTabId === TabID.Reviews; prefetch on idle) {
                <div class="mb-3">
                  <app-carousel-reel [items]="reviews" [alwaysShow]="true" [title]="t('user-reviews-local')"
                                     iconClasses="fa-solid fa-{{getUserReview().length > 0 ? 'pen' : 'plus'}}"
                                     [clickableTitle]="true" (sectionClick)="openReviewModal()">
                    <ng-template #carouselItem let-item let-position="idx">
                      <app-review-card [review]="item" (refresh)="updateOrDeleteReview($event)"></app-review-card>
                    </ng-template>
                  </app-carousel-reel>
                </div>

                <div class="mb-3">
                  <app-carousel-reel [items]="plusReviews" [alwaysShow]="false" [title]="t('user-reviews-plus')">
                    <ng-template #carouselItem let-item let-position="idx">
                      <app-review-card [review]="item"></app-review-card>
                    </ng-template>
                  </app-carousel-reel>
                </div>
              }

            </ng-template>
          </li>

          @if (seriesMetadata) {
            <li [ngbNavItem]="TabID.Details">
              <a ngbNavLink>{{t('details-tab')}}</a>
              <ng-template ngbNavContent>
                @defer (when activeTabId === TabID.Details; prefetch on idle) {
                  <app-details-tab [metadata]="seriesMetadata"></app-details-tab>
                }
              </ng-template>
            </li>
          }

        </ul>
        <div [ngbNavOutlet]="nav" style="min-height: 300px"></div>
      }

      <app-loading [loading]="isLoading"></app-loading>
    </div>

    <ng-template #estimatedNextCard let-tabId="tabId">
      @if (nextExpectedChapter) {
        @switch (tabId) {
          @case (TabID.Volumes) {
            @if (nextExpectedChapter.volumeNumber !== SpecialVolumeNumber && nextExpectedChapter.chapterNumber === LooseLeafOrSpecialNumber) {
              <app-next-expected-card class="col-auto mt-2 mb-2" [entity]="nextExpectedChapter"
                                      [imageUrl]="imageService.getSeriesCoverImage(series.id)"></app-next-expected-card>
            }
          }
          @case (TabID.Chapters) {
            <app-next-expected-card class="col-auto mt-2 mb-2" [entity]="nextExpectedChapter" [imageUrl]="imageService.getSeriesCoverImage(series.id)"></app-next-expected-card>
          }
          @case (TabID.Storyline) {
            <app-next-expected-card class="col-auto mt-2 mb-2" [entity]="nextExpectedChapter" [imageUrl]="imageService.getSeriesCoverImage(series.id)"></app-next-expected-card>
          }
        }
      }
    </ng-template>
  }


</ng-container>

<ng-template #nonSpecialChapterCard let-item let-scroll="scroll" let-idx="idx" let-totalLength="totalLength">
  <app-chapter-card class="col-auto mt-2 mb-2" [chapter]="item" [seriesId]="series.id"
                    [libraryId]="libraryId"
                    [actions]="chapterActions"
                    (selection)="bulkSelectionService.handleCardSelection('chapter', scroll.viewPortInfo.startIndexWithBuffer + idx, totalLength, $event)"
                    [selected]="bulkSelectionService.isCardSelected('chapter', scroll.viewPortInfo.startIndexWithBuffer + idx)" [allowSelection]="true">
  </app-chapter-card>
</ng-template>

<ng-template #nonChapterVolumeCard let-item let-scroll="scroll" let-idx="idx" let-totalLength="totalLength">
  <app-volume-card class="col-auto mt-2 mb-2" [volume]="item" [seriesId]="seriesId" [libraryId]="libraryId" [libraryType]="libraryType"
                   [actions]="volumeActions"
                   (selection)="bulkSelectionService.handleCardSelection('volume', scroll.viewPortInfo.startIndexWithBuffer + idx, totalLength, $event)"
                   [selected]="bulkSelectionService.isCardSelected('volume', scroll.viewPortInfo.startIndexWithBuffer + idx)" [allowSelection]="true">
  </app-volume-card>
</ng-template>

<ng-template #specialChapterCard let-item let-scroll="scroll" let-idx="idx" let-totalLength="totalLength">
  <app-chapter-card class="col-auto mt-2 mb-2" [chapter]="item" [seriesId]="series.id"
                    [libraryId]="libraryId"
                    [actions]="chapterActions"
                    (selection)="bulkSelectionService.handleCardSelection('special', scroll.viewPortInfo.startIndexWithBuffer + idx, totalLength, $event)"
                    [selected]="bulkSelectionService.isCardSelected('special', scroll.viewPortInfo.startIndexWithBuffer + idx)" [allowSelection]="true">
  </app-chapter-card>

</ng-template>

<ng-template #nonSpecialChapterListItem let-item>
  <app-list-item [imageUrl]="imageService.getChapterCoverImage(item.id)" [libraryId]="libraryId"
                 [seriesName]="series.name" [entity]="item"
                 [actions]="chapterActions" [libraryType]="libraryType" imageWidth="130px" imageHeight=""
                 [pagesRead]="item.pagesRead" [totalPages]="item.pages" (read)="openChapter(item)"
                 [blur]="user?.preferences?.blurUnreadSummaries || false">
    <ng-container title>
      <app-entity-title [libraryType]="libraryType" [entity]="item" [seriesName]="series.name" [prioritizeTitleName]="false"></app-entity-title>
    </ng-container>
  </app-list-item>
</ng-template>

<ng-template #nonSpecialVolumeListItem let-item>
  <app-list-item [imageUrl]="imageService.getVolumeCoverImage(item.id)" [libraryId]="libraryId"
                 [seriesName]="series.name" [entity]="item"
                 [actions]="volumeActions" [libraryType]="libraryType" imageWidth="130px" imageHeight=""
                 [pagesRead]="item.pagesRead" [totalPages]="item.pages" (read)="openVolume(item)"
                 [blur]="user?.preferences?.blurUnreadSummaries || false">
    <ng-container title>
      <app-entity-title [libraryType]="libraryType" [entity]="item" [seriesName]="series.name" [prioritizeTitleName]="false"></app-entity-title>
    </ng-container>
  </app-list-item>
</ng-template>

<ng-template #specialChapterListItem let-item>
  <app-list-item [imageUrl]="imageService.getChapterCoverImage(item.id)" [libraryId]="libraryId"
                 [seriesName]="series.name" [entity]="item"
                 [actions]="chapterActions" [libraryType]="libraryType" imageWidth="130px" imageHeight=""
                 [pagesRead]="item.pagesRead" [totalPages]="item.pages" (read)="openChapter(item)"
                 [blur]="user?.preferences?.blurUnreadSummaries || false">
    <ng-container title>
      {{item.title || item.range}}
    </ng-container>
  </app-list-item>
</ng-template>
